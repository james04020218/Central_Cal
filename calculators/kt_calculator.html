<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KT 결합 할인 계산기 (상담 기능 추가)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Noto Sans KR 폰트 불러오기 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8fafc; 
        }
        .input-group { margin-bottom: 1.5rem; }
        .input-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #334155; }
        .input-field, .select-field { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; box-shadow: sm; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        .input-field:focus, .select-field:focus { border-color: #0ea5e9; outline: none; box-shadow: 0 0 0 0.2rem rgba(14, 165, 233, 0.25); }
        .input-field:disabled, .select-field:disabled { background-color: #e2e8f0; cursor: not-allowed; }
        .btn-primary { background-color: #0ea5e9; color: white; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #0284c7; }
        .btn-secondary { background-color: #64748b; color: white; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.3s ease; }
        .btn-secondary:hover { background-color: #475569; }
        .section-title { font-size: 1.5rem; font-weight: 700; color: #0369a1; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #38bdf8;}
        .result-card { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); margin-bottom: 1.5rem; }
        .radio-label { margin-right: 1rem; margin-bottom: 0.5rem; display: inline-flex; align-items: center; cursor: pointer;}
        .radio-input { margin-right: 0.5rem; accent-color: #0ea5e9; }
        .info-box { background-color: #eff6ff; border-left: 4px solid #3b82f6; padding: 1rem; margin-top:0.5rem; margin-bottom:1rem; font-size: 0.875rem; color: #1e40af; }
        .info-box ul { padding-left: 1.25rem; list-style-type: disc; }
        .info-box ul ul { padding-left: 1rem; list-style-type: circle;}
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-left: 10px; vertical-align: middle;}
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px;}
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%;}
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(20px); }
        .discount-details { background-color: #e0f2fe; border: 1px solid #7dd3fc; padding: 1rem; border-radius: 0.375rem; font-size:0.875rem; }
        .discount-details ul { padding-left: 1.25rem; }
        .discount-details ul ul { padding-left: 1rem; }
    </style>
</head>
<body class="text-slate-800">
    <header class="bg-sky-700 text-white p-6 shadow-md">
        <div class="container mx-auto max-w-4xl">
            <h1 class="text-3xl font-bold text-center">KT 결합 할인 계산기</h1>
            <p class="text-center text-sky-200 mt-1">선택하신 서비스와 할인 유형에 따른 예상 요금을 계산해 보세요.</p>
        </div>
    </header>

    <main class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
        <section id="inputSection" class="mb-8">
            <h2 class="section-title">1. 서비스 선택 (3년 약정 기준, VAT 포함)</h2>
            <p class="mb-4 text-sm text-slate-600">아래 항목들을 선택해주세요. 모든 요금은 KT 표준 3년 약정, 부가세 포함 금액을 기준으로 합니다.</p>
            
            <div class="mb-4 text-sm">
                <span class="font-semibold text-sky-700">KT 인터넷 상품청약 본인인증 링크:</span>
                <a href="https://online.kt.com/smart/simple/simpleCustomerInfoPop.do?prdcId=0F0BA335-ACD6-459E-BDB3-95CE61EEFE35" target="_blank" class="text-blue-600 hover:text-blue-700 underline font-medium">바로가기 (PASS 또는 신용카드 인증)</a>
            </div>

            <div class="input-group">
                <label class="input-label">인터넷 유형 선택</label>
                <div class="flex items-center space-x-4">
                    <label class="radio-label">
                        <input type="radio" name="internetType" value="bundle" class="radio-input">
                        인터넷 + TV 번들
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="internetType" value="standalone" class="radio-input" checked>
                        인터넷 단독
                    </label>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="input-group">
                    <label for="internetPlan" class="input-label">인터넷 요금제</label>
                    <select id="internetPlan" class="select-field">
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="wifiRouterRental" class="input-label block mb-1">와이파이 공유기</label>
                    <select id="wifiRouterRental" class="select-field">
                        <option value="1100" data-name="KT공유기">KT공유기 (월 1,100원)</option>
                        <option value="0" data-name="GiGA WiFi home ax">GiGA WiFi home ax (프로모션 무료)</option>
                        <option value="0" data-name="KT WiFi 7D">KT WiFi 7D (프로모션 무료)</option>
                        <option value="0" data-name="KT공유기 X">KT공유기 X (미사용)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="tvPlan" class="input-label">TV 요금제 (1번째 TV, 기가지니A 포함가)</label>
                    <select id="tvPlan" class="select-field">
                        <option value="none" data-category="없음" data-stb-included-price="0">선택 안함</option>
                        <option value="KTTV베이직" data-price="15400" data-category="베이직" data-stb-included-price="15400">KTTV베이직 (236채널) + 기가지니A (월 15,400원)</option>
                        <option value="KTTV라이트" data-price="16500" data-category="라이트" data-stb-included-price="16500">KTTV라이트 (240채널) + 기가지니A (월 16,500원)</option>
                        <option value="KTTV에센스" data-price="19800" data-category="에센스" data-stb-included-price="19800">KTTV에센스 (266채널) + 기가지니A (월 19,800원)</option>
                        <option value="KTTV에센스 플러스" data-price="24200" data-category="에센스 플러스" data-stb-included-price="24200">KTTV에센스 플러스 (266+채널) (월 24,200원)</option>
                        <option value="KTTV넷플릭스 HD" data-price="31100" data-category="넷플릭스 HD" data-stb-included-price="31100">KTTV넷플릭스 HD (267채널) (월 31,100원)</option>
                        <option value="KTTV넷플릭스 UHD" data-price="34600" data-category="넷플릭스 UHD" data-stb-included-price="34600">KTTV넷플릭스 UHD (267채널) (월 34,600원)</option>
                        <option value="KTTV키즈랜드팩초이스" data-price="20900" data-category="키즈랜드" data-stb-included-price="20900">KTTV키즈랜드팩초이스 (월 20,900원)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="additionalTvPlan" class="input-label">추가 TV 선택 (2번째 TV)</label>
                    <select id="additionalTvPlan" class="select-field">
                        <option value="none" data-price="0" data-name="선택 안함">선택 안함</option>
                        <option value="KTTV 추가베이직" data-price="10670" data-name="베이직 (236채널) + 기가지니A">KTTV 추가베이직 (236채널) + 기가지니A (월 10,670원)</option>
                        <option value="KTTV 추가라이트" data-price="11220" data-name="라이트 (240채널) + 기가지니A">KTTV 추가라이트 (240채널) + 기가지니A (월 11,220원)</option>
                        <option value="KTTV 추가에센스" data-price="13420" data-name="에센스 (266채널) + 기가지니A">KTTV 추가에센스 (266채널) + 기가지니A (월 13,420원)</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="phonePlan" class="input-label">집전화 요금제</label>
                    <select id="phonePlan" class="select-field">
                        <option value="none">선택 안함</option>
                        <option value="KT일반 전화일반 전화" data-price="6050">KT일반 전화일반 전화 (월 6,050원)</option>
                        <option value="KT일반 전화인터넷 전화 (모임스톤)" data-price="5940">KT일반 전화인터넷 전화 (모임스톤) (월 5,940원)</option>
                        <option value="KT일반 전화인터넷 (단독) 500mb 이상 + 인터넷 전화" data-price="3850">KT일반 전화인터넷 (단독) 500mb 이상 + 인터넷 전화 (월 3,850원, 패밀리 중복불가)</option>
                    </select>
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label">KT 부가서비스 (선택)</label>
                <div id="addonServicesContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <label class="flex items-center"><input type="checkbox" name="addonService" value="기가지니3A" data-price="1100" class="radio-input mr-2">기가지니3A (AI 셋톱박스) (월 1,100원)</label>
                    <label class="flex items-center"><input type="checkbox" name="addonService" value="AI 지니 TV 올인원 사운드바" data-price="5500" class="radio-input mr-2">AI 지니 TV 올인원 사운드바 (월 5,500원)</label>
                    <label class="flex items-center"><input type="checkbox" name="addonService" value="버디증폭기" data-price="1650" class="radio-input mr-2">버디증폭기 (월 1,650원)</label>
                    <label class="flex items-center"><input type="checkbox" name="addonService" value="기가지니 4A" data-price="3300" class="radio-input mr-2">기가지니 4A (월 3,300원)</label>
                </div>
            </div>
        </section>

        <section class="mb-8">
             <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-r-lg shadow">
                <h3 class="font-bold">✨ 중요 안내: 결합 할인 신청 방법</h3>
                <p class="mt-2 text-sm">
                    모든 결합 할인은 인터넷 설치가 완료된 후, <strong class="underline">고객님께서 직접 이용 중인 통신사 고객센터(모바일 114)로 전화</strong>하시어 "인터넷과 모바일(또는 TV) 결합해주세요"라고 요청하셔야 최종적으로 적용됩니다.
                </p>
            </div>
        </section>

        <section id="discountTypeSection" class="mb-8">
            <h2 class="section-title">2. 결합 할인 유형 선택</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <p class="mb-4 text-sm text-slate-600">가장 유리한 할인 유형을 선택하거나, 각 유형별 예상 요금을 비교해보세요.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                    <label class="radio-label"><input type="radio" name="discountType" value="none" class="radio-input"> 결합 할인 없음</label>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="totalAmountBundle" class="radio-input" checked> 총액 결합할인</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="totalAmountDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="premiumFamilyBundle" class="radio-input"> 프리미엄 가족결합</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="premiumFamilyDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="premiumSingleBundle" class="radio-input"> 프리미엄 싱글결합</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="premiumSingleDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="mvnoBundle" class="radio-input"> 알뜰폰 결합</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="mvnoDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="familyBundle" class="radio-input"> 패밀리 결합 (인터넷 추가회선)</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="familyBundleDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="separateFamilyBundle" class="radio-input"> 따로 살아도 가족결합</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="separateFamilyDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                </div>

                <div id="totalAmountDetailsContainer" class="mt-4 hidden discount-details"></div>
                <div id="premiumFamilyDetailsContainer" class="mt-4 hidden discount-details"></div>
                <div id="premiumSingleDetailsContainer" class="mt-4 hidden discount-details"></div>
                <div id="familyBundleDetailsContainer" class="mt-4 hidden discount-details"></div>
                <div id="separateFamilyDetailsContainer" class="mt-4 hidden discount-details"></div>
                <div id="mvnoDetailsContainer" class="mt-4 hidden discount-details"></div>

                <div class="input-group mt-6">
                    <label class="input-label">모바일 회선 정보 (최대 5회선)</label>
                    <div class="flex items-center mb-2">
                        <label for="mobileLinesCount" class="mr-2 text-sm text-slate-700">결합할 모바일 회선 수:</label>
                        <input type="number" id="mobileLinesCount" min="0" max="5" value="0" class="input-field w-20 text-center">
                    </div>
                    <div id="mobileLinesContainer" class="space-y-3"></div>
                </div>
                <div class="input-group mt-6">
                    <label for="dongpanSalesCheckKt" class="input-label flex items-center cursor-pointer">
                        <input type="checkbox" id="dongpanSalesCheckKt" class="radio-input h-5 w-5 mr-2">
                        KT 동판유심 판매 시 추가 사은품 적용 및 안내 보기
                    </label>
                    <div id="dongpanPolicyDetailsContainerKt" class="mt-3 hidden info-box">
                        <h4 class="font-semibold text-sm mb-2">KT 인터넷 유심 개통 절차 안내 (상담원 참고용)</h4>
                        <p class="text-xs mb-1"><strong>신청 및 인증:</strong></p>
                        <ul class="list-disc list-inside text-xs space-y-0.5 mb-2">
                            <li>KT 인터넷 유심 개통 신청서 링크: <a href="http://online.kt.com/index.jsp?prdcID=6C463388-3BDF-4E68-BE73-975E05BDA182" target="_blank" class="text-blue-700 font-bold hover:text-blue-800 underline text-lg">바로가기</a> (PASS 또는 신용카드 인증 필요)</li>
                            <li>KT 동판 결합 본인인증 링크 (결합만 체크): <a href="https://online.kt.com/smart/simple/simpleCustomerInfoPop.do?prdcId=65278B4C-20F1-47FA-9EEF-56E9B574D346" target="_blank" class="text-blue-600 hover:underline font-semibold">바로가기</a></li>
                        </ul>
                        <p class="text-xs mb-1"><strong>결합 가능 회선:</strong> 인터넷 + 유심 동판 + 가족 유심 2회선 (총 3회선까지 가능)</p>
                        <p class="text-xs mb-1"><strong>접수 과정:</strong> 백메가 접수웹(speedonline.kr) KT(일반) > 모바일 탭으로 접수</p>
                        <p class="text-xs mb-1"><strong>접수 시 필수 기재 사항 (기타메모 양식):</strong></p>
                        <ul class="list-disc list-inside text-xs space-y-0.5 mb-2">
                            <li>인터넷 개통 완료 시: "[개통 완료 / 유심 발송 요청]"</li>
                            <li>이미 개통된 고객 30일 이내 동판 시: "[개통완료 일자, 개통번호 기재 / 유심 발송 요청]"</li>
                            <li>고객 유심 수령 후 개통 요청 시: "[고객 유심 수령 완료 / 개통 진행 요청]"</li>
                        </ul>
                        <p class="text-xs mb-1"><strong>개통 진행 및 유의사항:</strong></p>
                        <ul class="list-disc list-inside text-xs space-y-0.5 mb-2">
                            <li>고객에게 위약금 확인 및 동의 문자 발송 후 처리. 미동의 시 10분 후 강제 동의 처리 가능.</li>
                            <li>USIM 교체 및 전원 ON 성공 후 선택약정 및 유무선 결합 필수 (완료 시 개통 완료 처리).</li>
                            <li>유심 개통 최대 4시간 소요 가능. 사전 동의 문자 처리 시 빠른 개통.</li>
                            <li>KT USIM 개통 전까지 기존 USIM 사용, 신호 끊기면 교체. 기기 수회 재시동 필요.</li>
                        </ul>
                        <p class="text-xs mb-1"><strong>비용 및 수수료 주의사항:</strong></p>
                        <ul class="list-disc list-inside text-xs space-y-0.5">
                            <li>유심 당일 발송 마감 15시.</li>
                            <li>유심 비용 7,700원 / 번호이동 수수료 800원 첫 달 청구.</li>
                            <li>인터넷/유심 중 하나라도 설치/개통 불가 시 수수료 지급 불가.</li>
                            <li>인터넷 개통월 기준 익월 말까지 유심 개통 시 수수료 인정.</li>
                            <li>선택약정 미적용 시 수수료 지급 불가.</li>
                            <li>인터넷/유심 명의자 상이해도 유심 수수료 지급 가능.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="displayModeSectionKt" class="mb-8">
            <h2 class="section-title">결제금액 표시 방식 선택</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <label class="radio-label">
                    <input type="radio" name="displayModeKt" value="preApplied" class="radio-input" checked>
                    선결합 기준 (할인이 적용된 최종 월 납부액)
                </label>
                <label class="radio-label">
                    <input type="radio" name="displayModeKt" value="postApplied" class="radio-input">
                    후결합 기준 (할인이 적용되기 전 총 서비스 월 기본료)
                </label>
            </div>
        </section>

        <section id="installationSection" class="mb-8">
            <h2 class="section-title">3. 설치 옵션</h2>
            <div class="input-group bg-white p-6 rounded-lg shadow">
                <label class="input-label">설치 희망 시점 (설치비 변동)</label>
                <div class="space-y-2">
                    <label class="radio-label"><input type="radio" name="installationTime" value="weekday" class="radio-input" checked> 평일 주간</label>
                    <label class="radio-label"><input type="radio" name="installationTime" value="weekend" class="radio-input"> 주말/야간 (할증 적용)</label>
                </div>
            </div>
        </section>

        <div class="text-center mb-8 flex justify-center items-center">
            <button id="calculateButton" class="btn-primary text-lg">예상 요금 계산하기</button>
            <button id="resetButton" class="btn-secondary text-lg ml-4">초기화</button>
        </div>

        <section id="resultSection" class="hidden">
            <h2 class="section-title">📊 계산 결과</h2>
            
            <div class="result-card">
                <h3 class="text-xl font-semibold text-sky-600 mb-4">✅ 최종 요금 및 혜택 요약</h3>
                <div class="grid grid-cols-2 gap-6 text-center">
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <p class="text-sm text-slate-600">🖥️ 인터넷/TV 월 최종 요금</p>
                        <p id="summaryPreDiscountCost" class="text-sm text-slate-500" style="display: none;"></p>
                        <p id="summaryFinalCost" class="text-3xl font-bold text-red-600 my-2">0 원</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-sm text-slate-600">🎁 총 사은품 혜택</p>
                        <p id="summaryGiftTotal" class="text-3xl font-bold text-green-700 my-2">0 원</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <p class="text-sm text-slate-600">📉 인터넷 요금 할인</p>
                        <p id="summaryInternetDiscount" class="text-xl font-bold text-sky-600 my-2">0 원</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-sm text-slate-600">📱 휴대폰 요금 할인</p>
                        <p id="summaryMobileDiscount" class="text-xl font-bold text-green-700 my-2">0 원</p>
                    </div>
                </div>
            </div>

            <!-- 고객용 상담 버튼 섹션 -->
            <div id="customerConsultSection" class="result-card hidden">
                <h3 class="text-xl font-semibold text-sky-600 mb-4">💬 이 결과로 상담하기</h3>
                <p class="text-sm text-slate-600 mb-4">계산 결과를 전문가에게 보내고 바로 상담을 시작하세요!</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <a id="kakaoBtn" href="#" target="_blank" class="flex-1 text-center font-bold py-3 px-4 rounded-lg bg-[#FEE500] text-[#191919] hover:opacity-90 transition-opacity">
                        카카오톡으로 보내기
                    </a>
                    <a id="smsBtn" href="#" class="flex-1 text-center font-bold py-3 px-4 rounded-lg bg-slate-700 text-white hover:bg-slate-800 transition-colors">
                        문자 메시지로 보내기
                    </a>
                </div>
            </div>
            
            <div class="text-center mt-6">
                <button id="toggleDetailsButton" class="text-sm text-slate-500 hover:text-sky-600 bg-slate-100 px-4 py-2 rounded-full">
                    상세 요금 내역 펼쳐보기 ▼
                </button>
            </div>


            <div id="expandedDetailsContainer" class="hidden mt-6">
                <div class="result-card">
                    <h3 class="text-2xl font-bold text-blue-700 mb-4">📋 상세 요금 내역</h3>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                        <p><strong>선택 인터넷:</strong> <span id="selectedInternet"></span></p>
                        <p><strong>모바일 회선 수:</strong> <span id="selectedMobileCount"></span></p>
                        <p><strong>선택 TV (1번째):</strong> <span id="selectedTv"></span></p>
                        <p><strong>적용 할인 유형:</strong> <span id="selectedDiscountType"></span></p>
                        <p><strong>선택 추가 TV (2번째):</strong> <span id="selectedAdditionalTv"></span></p>
                        <p><strong>선택 집전화:</strong> <span id="selectedPhone"></span></p>
                        <p><strong>선택 와이파이:</strong> <span id="selectedWifi"></span></p>
                        <div></div> <div class="col-span-2" id="selectedWifiDetails"></div> 
                    </div>
                </div>

                <div class="result-card">
                    <h3 class="text-lg font-semibold text-blue-700 mb-3">🖥️ 인터넷/TV 요금 계산 과정</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>월 인터넷 기본료 (단독/TV결합 기준)</span><span id="detailInternetBase">0 원</span></div>
                        <div class="flex justify-between"><span>월 와이파이 공유기 임대료</span><span id="detailWifiFee">0 원</span></div>
                        <div class="flex justify-between text-green-600"><span>월 총 인터넷 결합 할인액 (예상)</span><span id="detailInternetDiscountTotal">0 원</span></div>
                        <hr class="my-2">
                        <div class="flex justify-between font-bold text-base"><span>최종 예상 월 납부액 (할인 적용)</span><span id="detailFinalCost" class="text-red-600">0 원</span></div>
                    </div>
                </div>

                <div class="result-card">
                    <h3 class="text-lg font-semibold text-blue-700 mb-3">📱 모바일 요금 할인 상세</h3>
                    <div id="mobileDiscountDetailContainer" class="p-3 bg-blue-50 rounded-md text-sm">
                        <p>결합 유형에 따른 모바일 할인 내역이 여기에 표시됩니다.</p>
                    </div>
                </div>

                <div class="result-card">
                    <h3 class="text-lg font-semibold text-blue-700 mb-3">🎁 사은품 혜택 상세</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>기본 사은품 (현금)</span><span id="giftCash">0 원</span></div>
                        <div class="flex justify-between"><span>기본 사은품 (상품권)</span><span id="giftVoucher">0 원</span></div>
                        <div class="flex justify-between"><span>일반전화 추가 상품권</span><span id="giftPhoneVoucher">0 원</span></div>
                        <div class="flex justify-between"><span>추가 TV 사은품 (현금)</span><span id="giftAdditionalTv">0 원</span></div>
                        <div id="dongpanCashContainerKt" class="flex justify-between hidden"><span>동판 추가 현금 사은품 (KT)</span><span id="giftDongpanAdditionalCashKt">0 원</span></div>
                        <hr class="my-2">
                        <div class="flex justify-between font-bold text-base"><span>총 사은품 가치 (예상)</span><span id="giftTotal" class="text-green-700">0 원</span></div>
                    </div>
                </div>
            </div>
            
            <section id="installationFeeSection" class="hidden">
                 <div class="result-card">
                    <h3 class="text-lg font-semibold text-blue-700 mb-3">⚙️ 설치비 (첫 달 1회 청구)</h3>
                    <div class="text-center">
                        <p id="installationFeeResult" class="text-2xl font-bold text-slate-800 my-2">0 원</p>
                        <p id="installationFeeDescription" class="text-sm text-slate-500"></p>
                    </div>
                </div>
            </section>
        </section>
    </main>

    <footer class="text-center p-6 mt-12 bg-sky-800 text-sky-200 text-sm">
        <p>본 계산기는 KT 미소에서 제공합니다.</p>
        <p>&copy; 2024 KT 결합 할인 계산기. 모든 정보는 참고용입니다.</p>
    </footer>

    <script>
    // --- ⚙️ 사장님 정보 및 데이터 ---
    const myPhoneNumber = '01042978846'; // 상담원 전화번호
    const kakaoChannelId = '_xkxnjxG';   // 카카오톡 채널 ID (_부터 시작하는 영문)

    // --- 나머지 데이터(요금표 등)는 그대로 유지 ---
    const internetPlans_KT = {
        "KT인터넷(단독) 100mb": { basePrice: 22000, speed: 100, type: "100M" },
        "KT인터넷(단독) 500mb": { basePrice: 33000, speed: 500, type: "500M" },
        "KT인터넷(단독) 1GB": { basePrice: 38500, speed: 1000, type: "1G" },
        "KT인터넷번들100mb": { basePrice: 22000, speed: 100, type: "100M" },
        "KT인터넷번들500mb": { basePrice: 27500, speed: 500, type: "500M" },
        "KT인터넷번들1GB": { basePrice: 33000, speed: 1000, type: "1G" }
    };
    const tvPlans_KT = {
        "KTTV베이직": { basePrice: 15400, category: "베이직", stbIncluded: "기가지니A" },
        "KTTV라이트": { basePrice: 16500, category: "라이트", stbIncluded: "기가지니A" },
        "KTTV에센스": { basePrice: 19800, category: "에센스", stbIncluded: "기가지니A" },
        "KTTV에센스 플러스": { basePrice: 24200, category: "에센스 플러스", stbIncluded: "기가지니A" },
        "KTTV넷플릭스 HD": { basePrice: 31100, category: "넷플릭스 HD", stbIncluded: "기가지니A" },
        "KTTV넷플릭스 UHD": { basePrice: 34600, category: "넷플릭스 UHD", stbIncluded: "기가지니A" },
        "KTTV키즈랜드팩초이스": { basePrice: 20900, category: "키즈랜드", stbIncluded: "기가지니A" }
    };
    const additionalTvPlans_KT = {
        "none": { basePrice: 0, name: "선택 안함" },
        "KTTV 추가베이직": { basePrice: 10670, name: "베이직 (236채널) + 기가지니A" },
        "KTTV 추가라이트": { basePrice: 11220, name: "라이트 (240채널) + 기가지니A" },
        "KTTV 추가에센스": { basePrice: 13420, name: "에센스 (266채널) + 기가지니A" }
    };
    const phonePlans_KT = {
        "KT일반 전화일반 전화": { basePrice: 6050 },
        "KT일반 전화인터넷 전화 (모임스톤)": { basePrice: 5940 },
        "KT일반 전화인터넷 (단독) 500mb 이상 + 인터넷 전화": { basePrice: 3850 }
    };
    const wifiOptions_KT = {
        "KT공유기": { fee: 1100, name: "KT공유기", url: null, promotion: null },
        "GiGA WiFi home ax": { fee: 0, name: "GiGA WiFi home ax (프로모션)", url: "https://product.kt.com/wDic/productDetail.do?ItemCode=1401", promotion: "'베이직(500Mbps)' 요금제 신규 가입 시 무료 제공" },
        "KT WiFi 7D": { fee: 0, name: "KT WiFi 7D (프로모션)", url: "https://product.kt.com/wDic/productDetail.do?ItemCode=1633", promotion: "'에센스(1Gbps)' 이상 요금제 신규 가입 시 무료 제공 (25년 8/31까지, 선착순 5만명)" },
        "KT공유기 X": { fee: 0, name: "KT공유기 X (미사용)", url: null, promotion: null }
    };
    const ktAddonServices = {
        "기가지니3A": { price: 1100, name: "기가지니3A (AI 셋톱박스)"},
        "AI 지니 TV 올인원 사운드바": { price: 5500, name: "AI 지니 TV 올인원 사운드바"},
        "버디증폭기": { price: 1650, name: "버디증폭기"},
        "기가지니 4A": { price: 3300, name: "기가지니 4A"}
    };
    const mobilePlans_KT = [
        { "category": "90K", "name": "디즈니+ 초이스 스페셜", "network": "5G", "price": 110000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1470" },
        { "category": "90K", "name": "(유튜브 프리미엄) 초이스 스페셜", "network": "5G", "price": 110000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1499" },
        { "category": "90K", "name": "넷플릭스 초이스 스페셜", "network": "5G", "price": 110000, "url": "https://product.kt.com/wDic/simple/mNetflixMain.do" },
        { "category": "90K", "name": "티빙/지니/밀리 초이스 스페셜", "network": "5G", "price": 110000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1601" },
        { "category": "90K", "name": "넷플릭스 초이스 베이직", "network": "5G", "price": 90000, "url": "https://product.kt.com/wDic/simple/mNetflixMain.do" },
        { "category": "90K", "name": "티빙/지니/밀리 초이스 베이직", "network": "5G", "price": 90000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1601" },
        { "category": "90K", "name": "디즈니+ 초이스 베이직", "network": "5G", "price": 90000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1470" },
        { "category": "90K", "name": "(유튜브 프리미엄) 초이스 베이직", "network": "5G", "price": 90000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1499" },
        { "category": "61K", "name": "데이터ON 프리미엄", "network": "LTE", "price": 89000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1248" },
        { "category": "61K", "name": "베이직", "network": "5G", "price": 80000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1283" },
        { "category": "61K", "name": "5G 심플 110GB", "network": "5G", "price": 69000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1406&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "61K", "name": "데이터ON 비디오 플러스", "network": "LTE", "price": 69000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1248" },
        { "category": "61K", "name": "5G 심플 90GB", "network": "5G", "price": 67000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1406&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "61K", "name": "5G 심플 70GB", "network": "5G", "price": 65000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1406&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "61K", "name": "5G 심플 50GB", "network": "5G", "price": 63000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1406&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "61K", "name": "5G 심플 30GB", "network": "5G", "price": 61000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1406&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 슬림 21GB", "network": "5G", "price": 58000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 슬림 21GB (이월)", "network": "5G", "price": 58000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 슬림 14GB", "network": "5G", "price": 55000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 슬림 14GB (이월)", "network": "5G", "price": 55000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 슬림 10GB", "network": "5G", "price": 50000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 슬림 10GB (이월)", "network": "5G", "price": 50000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 시니어 베이직", "network": "5G", "price": 49000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1558&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 슬림 7GB", "network": "5G", "price": 45000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 슬림 7GB (이월)", "network": "5G", "price": 45000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 시니어 A형", "network": "5G", "price": 44000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1558&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 시니어 B형", "network": "5G", "price": 42000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1558&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 시니어 C형", "network": "5G", "price": 41000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1558&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 슬림 5GB", "network": "5G", "price": 37000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
        { "category": "37K", "name": "5G 슬림 4GB (이월)", "network": "5G", "price": 37000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" }
    ].sort((a, b) => b.price - a.price);
    const newKtDiscountRules = {
        "총액결합할인": {
            "100M": {
                "단독": {"모바일_22000미만": 1650, "모바일_64900미만": 3300, "모바일_64900이상": 5500},
                "TV":   {"모바일_22000미만": 1650, "모바일_64900미만": 3300, "모바일_64900이상": 5500}
            },
            "500M": {
                "단독": {"모바일_22000미만": 7700, "모바일_22000이상": 11000},
                "TV":   {"모바일_22000미만": 2200, "모바일_22000이상": 5500}
            },
            "1G": {
                "단독": {"모바일_22000미만": 7700, "모바일_22000이상": 11000},
                "TV":   {"모바일_결합시": 5500}
            }
        },
        "프리미엄가족결합": { "500M_TV": 5500, "1G_TV": 5500, "500M_단독": 5500, "1G_단독": 11000 },
        "프리미엄싱글결합": { "500M_단독": 5500, "1G_단독": 5500 },
        "패밀리결합": { "100M_TV": 5500, "100M_단독": 5500, "500M_TV": 5500, "500M_단독": 11000, "1G_TV": 5500, "1G_단독": 11000 },
        "알뜰폰결합": { "100M_TV": 3300, "100M_단독": 3300, "500M_TV": 5500, "500M_단독": 11000, "1G_TV": 5500, "1G_단독": 11000 },
        "따로살아도 가족결합": {
            "500M_TV": { "모바일_22000미만": 9900, "모바일_22000이상": 13200, "tvDiscount": 2200 },
            "1G_TV": { "모바일_22000미만": 11000, "모바일_22000이상": 14300, "tvDiscount": 3300 }
        }
    };
    const dongpanAdditionalGiftTable_KT = {
        "37K": { "100M_단독": 150000, "500M_단독": 160000, "1G_단독": 170000, "100M_TV번들": 200000, "500M_TV번들": 220000, "1G_TV번들": 240000 },
        "61K": { "100M_단독": 270000, "500M_단독": 280000, "1G_단독": 290000, "100M_TV번들": 320000, "500M_TV번들": 340000, "1G_TV번들": 360000 },
        "90K": { "100M_단독": 310000, "500M_단독": 320000, "1G_단독": 330000, "100M_TV번들": 360000, "500M_TV번들": 380000, "1G_TV번들": 400000 }
    };
    const ktInstallationFees_new = {
        "평일": { "인터넷": 36000, "인터넷+TV": 56200, "인터넷+일반전화": 68000, "인터넷+070전화": 60000, "인터넷+TV+일반전화": 88200, "인터넷+TV+070전화": 80200, "인터넷+TV+TV추가": 71600 },
        "주말": { "유효기간": "25.06.29까지 할증 없음", "인터넷": 45000, "인터넷+일반전화": 86000, "인터넷+070전화": 78000, "인터넷+TV": 71250, "인터넷+TV+일반전화": 112250, "인터넷+TV+070전화": 104250, "인터넷+TV+TV추가": 90500 }
    };
    const giftTable = {
        "베이직": { "100단독":{cash:5e4,voucher:4e4},"500단독":{cash:1e5,voucher:4e4},"1G단독":{cash:9e4,voucher:5e4},"100번들":{cash:31e4,voucher:6e4},"500번들":{cash:39e4,voucher:6e4},"기가번들":{cash:36e4,voucher:9e4}},
        "라이트": { "100단독":{cash:5e4,voucher:4e4},"500단독":{cash:1e5,voucher:4e4},"1G단독":{cash:9e4,voucher:5e4},"100번들":{cash:31e4,voucher:6e4},"500번들":{cash:38e4,voucher:7e4},"기가번들":{cash:35e4,voucher:1e5}},
        "에센스": { "100단독":{cash:5e4,voucher:4e4},"500단독":{cash:1e5,voucher:4e4},"1G단독":{cash:9e4,voucher:5e4},"100번들":{cash:31e4,voucher:6e4},"500번들":{cash:42e4,voucher:3e4},"기가번들":{cash:32e4,voucher:3e4}},
        "에센스 플러스": { "100단독":{cash:5e4,voucher:4e4},"500단독":{cash:1e5,voucher:4e4},"1G단독":{cash:9e4,voucher:5e4},"100번들":{cash:31e4,voucher:6e4},"500번들":{cash:42e4,voucher:3e4},"기가번들":{cash:32e4,voucher:3e4}},
        "넷플릭스 HD": { "100단독":{cash:5e4,voucher:4e4},"500단독":{cash:1e5,voucher:4e4},"1G단독":{cash:9e4,voucher:5e4},"100번들":{cash:31e4,voucher:6e4},"500번들":{cash:39e4,voucher:6e4},"기가번들":{cash:36e4,voucher:9e4}},
        "넷플릭스 UHD": { "100단독":{cash:5e4,voucher:4e4},"500단독":{cash:1e5,voucher:4e4},"1G단독":{cash:9e4,voucher:5e4},"100번들":{cash:31e4,voucher:6e4},"500번들":{cash:39e4,voucher:6e4},"기가번들":{cash:36e4,voucher:9e4}},
        "키즈랜드": { "100단독":{cash:5e4,voucher:4e4},"500단독":{cash:1e5,voucher:4e4},"1G단독":{cash:9e4,voucher:5e4},"100번들":{cash:31e4,voucher:6e4},"500번들":{cash:39e4,voucher:6e4},"기가번들":{cash:36e4,voucher:9e4}}
    };
    const kt_total_mobile_fee_discounts = {
        "100M": { "tier1_under_22000":{internet_discount:1650,mobile_discount:0,total_discount:1650},"tier2_22000_to_64899":{internet_discount:3300,mobile_discount:0,total_discount:3300},"tier3_64900_to_108899":{internet_discount:5500,mobile_discount:3300,total_discount:8800},"tier4_108900_to_141899":{internet_discount:5500,mobile_discount:14300,total_discount:19800},"tier5_141900_to_174899":{internet_discount:5500,mobile_discount:18700,total_discount:24200},"tier6_over_174900":{internet_discount:5500,mobile_discount:23100,total_discount:28600}},
        "500M_1G": { "tier1_under_22000":{internet_discount:2200,mobile_discount:0,total_discount:2200},"tier2_22000_to_64899":{internet_discount:5500,mobile_discount:0,total_discount:5500},"tier3_64900_to_108899":{internet_discount:5500,mobile_discount:5500,total_discount:11e3},"tier4_108900_to_141899":{internet_discount:5500,mobile_discount:16610,total_discount:22110},"tier5_141900_to_174899":{internet_discount:5500,mobile_discount:22100,total_discount:27610},"tier6_over_174900":{internet_discount:5500,mobile_discount:27610,total_discount:33110}}
    };

    // --- 나머지 DOM 요소 선택자 및 함수는 그대로 유지 ---
    const internetPlanEl = document.getElementById('internetPlan');
    const wifiRouterRentalEl = document.getElementById('wifiRouterRental');
    const tvPlanEl = document.getElementById('tvPlan');
    const additionalTvPlanEl = document.getElementById('additionalTvPlan');
    const phonePlanEl = document.getElementById('phonePlan');
    const addonServicesContainerEl = document.getElementById('addonServicesContainer');
    const mobileLinesCountEl = document.getElementById('mobileLinesCount');
    const mobileLinesContainerEl = document.getElementById('mobileLinesContainer');
    const dongpanSalesCheckKtEl = document.getElementById('dongpanSalesCheckKt');
    const dongpanPolicyDetailsContainerKtEl = document.getElementById('dongpanPolicyDetailsContainerKt');
    const discountTypeRadios = document.querySelectorAll('input[name="discountType"]');
    const displayModeKtRadios = document.querySelectorAll('input[name="displayModeKt"]');
    const totalAmountDetailsToggleEl = document.getElementById('totalAmountDetailsToggle');
    const totalAmountDetailsContainerEl = document.getElementById('totalAmountDetailsContainer');
    const premiumFamilyDetailsToggleEl = document.getElementById('premiumFamilyDetailsToggle');
    const premiumFamilyDetailsContainerEl = document.getElementById('premiumFamilyDetailsContainer');
    const premiumSingleDetailsToggleEl = document.getElementById('premiumSingleDetailsToggle');
    const premiumSingleDetailsContainerEl = document.getElementById('premiumSingleDetailsContainer');
    const familyBundleDetailsToggleEl = document.getElementById('familyBundleDetailsToggle');
    const familyBundleDetailsContainerEl = document.getElementById('familyBundleDetailsContainer');
    const separateFamilyDetailsToggleEl = document.getElementById('separateFamilyDetailsToggle');
    const separateFamilyDetailsContainerEl = document.getElementById('separateFamilyDetailsContainer');
    const mvnoDetailsToggleEl = document.getElementById('mvnoDetailsToggle');
    const mvnoDetailsContainerEl = document.getElementById('mvnoDetailsContainer');
    const calculateButton = document.getElementById('calculateButton');
    const resetButton = document.getElementById('resetButton');
    const resultSection = document.getElementById('resultSection');
    const toggleDetailsButton = document.getElementById('toggleDetailsButton');
    const expandedDetailsContainer = document.getElementById('expandedDetailsContainer');
    const summaryPreDiscountCostEl = document.getElementById('summaryPreDiscountCost');
    const summaryFinalCostEl = document.getElementById('summaryFinalCost');
    const summaryInternetDiscountEl = document.getElementById('summaryInternetDiscount');
    const summaryGiftTotalEl = document.getElementById('summaryGiftTotal');
    const summaryMobileDiscountEl = document.getElementById('summaryMobileDiscount');
    const selectedInternetEl = document.getElementById('selectedInternet');
    const selectedTvEl = document.getElementById('selectedTv');
    const selectedAdditionalTvEl = document.getElementById('selectedAdditionalTv');
    const selectedPhoneEl = document.getElementById('selectedPhone');
    const selectedWifiEl = document.getElementById('selectedWifi');
    const selectedMobileCountEl = document.getElementById('selectedMobileCount');
    const selectedDiscountTypeEl = document.getElementById('selectedDiscountType');
    const selectedWifiDetailsEl = document.getElementById('selectedWifiDetails');
    const detailInternetBaseEl = document.getElementById('detailInternetBase');
    const detailWifiFeeEl = document.getElementById('detailWifiFee');
    const detailInternetDiscountTotalEl = document.getElementById('detailInternetDiscountTotal');
    const detailFinalCostEl = document.getElementById('detailFinalCost');
    const giftCashEl = document.getElementById('giftCash');
    const giftVoucherEl = document.getElementById('giftVoucher');
    const giftPhoneVoucherEl = document.getElementById('giftPhoneVoucher');
    const giftAdditionalTvEl = document.getElementById('giftAdditionalTv');
    const dongpanCashContainerKtEl = document.getElementById('dongpanCashContainerKt');
    const giftDongpanAdditionalCashKtEl = document.getElementById('giftDongpanAdditionalCashKt');
    const giftTotalEl = document.getElementById('giftTotal');
    const mobileDiscountDetailContainerEl = document.getElementById('mobileDiscountDetailContainer');
    const installationFeeSectionEl = document.getElementById('installationFeeSection');
    const installationFeeResultEl = document.getElementById('installationFeeResult');
    const installationFeeDescriptionEl = document.getElementById('installationFeeDescription');
    const customerConsultSection = document.getElementById('customerConsultSection');
    const kakaoBtn = document.getElementById('kakaoBtn');
    const smsBtn = document.getElementById('smsBtn');
    
    // --- 나머지 이벤트 리스너 및 함수는 그대로 유지 ---
    mobileLinesCountEl.addEventListener('input', updateMobileLinesInputs);
    calculateButton.addEventListener('click', calculateAndDisplayResults);
    resetButton.addEventListener('click', resetCalculator); 
    toggleDetailsButton.addEventListener('click', () => {
        expandedDetailsContainer.classList.toggle('hidden');
        const isHidden = expandedDetailsContainer.classList.contains('hidden');
        toggleDetailsButton.innerHTML = isHidden ? '상세 요금 내역 펼쳐보기 ▼' : '상세 요금 내역 접기 ▲';
    });
    if(dongpanSalesCheckKtEl) {
        dongpanSalesCheckKtEl.addEventListener('change', function() {
            if (dongpanPolicyDetailsContainerKtEl) {
                dongpanPolicyDetailsContainerKtEl.classList.toggle('hidden', !this.checked);
            }
            if (!resultSection.classList.contains('hidden')) {
                calculateAndDisplayResults();
            }
        });
    }
    const allDetailSections = [
        { radioValue: 'totalAmountBundle', toggleEl: totalAmountDetailsToggleEl, containerEl: totalAmountDetailsContainerEl, updateFn: updateTotalAmountDetails },
        { radioValue: 'premiumFamilyBundle', toggleEl: premiumFamilyDetailsToggleEl, containerEl: premiumFamilyDetailsContainerEl, updateFn: updatePremiumFamilyDetails },
        { radioValue: 'premiumSingleBundle', toggleEl: premiumSingleDetailsToggleEl, containerEl: premiumSingleDetailsContainerEl, updateFn: updatePremiumSingleDetails },
        { radioValue: 'familyBundle', toggleEl: familyBundleDetailsToggleEl, containerEl: familyBundleDetailsContainerEl, updateFn: updateFamilyBundleDetails },
        { radioValue: 'separateFamilyBundle', toggleEl: separateFamilyDetailsToggleEl, containerEl: separateFamilyDetailsContainerEl, updateFn: updateSeparateFamilyDetails },
        { radioValue: 'mvnoBundle', toggleEl: mvnoDetailsToggleEl, containerEl: mvnoDetailsContainerEl, updateFn: updateMvnoDetails }
    ];

    // ✨ [수정됨] 프리미엄 결합 시 요금제 비활성화 및 기본값 설정 로직 변경
    function updateMobilePlanOptions() {
        const selectedDiscountType = document.querySelector('input[name="discountType"]:checked').value;
        document.querySelectorAll('.mobile-plan-select').forEach((select, index) => {
            let isPremiumLine = false;
            // 프리미엄 싱글결합이거나, 프리미엄 가족결합의 첫 2회선일 경우 '프리미엄 회선'으로 간주
            if (selectedDiscountType === 'premiumSingleBundle' || (selectedDiscountType === 'premiumFamilyBundle' && index < 2)) {
                isPremiumLine = true;
            }

            let needsReset = false;
            for (const option of select.options) {
                const price = parseInt(option.value);
                if (price > 0) {
                    // 프리미엄 회선은 80,000원 미만 요금제 비활성화
                    if (isPremiumLine && price < 80000) {
                        option.disabled = true;
                        if (option.selected) needsReset = true;
                    } else {
                        option.disabled = false;
                    }
                }
            }
            // 비활성화된 요금제가 선택되어 있었다면, 기본값(80,000원)으로 재설정
            if (needsReset) {
                select.value = "80000"; 
                select.dispatchEvent(new Event('change'));
            }
        });
    }

    function updateInternetPlanOptions() {
        const selectedDiscountType = document.querySelector('input[name="discountType"]:checked').value;
        const restrictedTypes = ['separateFamilyBundle', 'premiumFamilyBundle', 'premiumSingleBundle'];
        const isRestricted = restrictedTypes.includes(selectedDiscountType);
        let wasChanged = false;
        for (const option of internetPlanEl.options) {
            if (!option.dataset.speed) continue;
            const speed = parseInt(option.dataset.speed);
            if (speed === 100) {
                if (isRestricted) {
                    option.disabled = true;
                    if (option.selected) {
                        internetPlanEl.value = 'none';
                        wasChanged = true;
                    }
                } else {
                    option.disabled = false;
                }
            }
        }
        if (wasChanged) {
            // Use custom modal or inline message instead of alert
            console.warn('선택하신 결합 유형은 100M 인터넷을 지원하지 않습니다. 500M 이상 인터넷 요금제를 선택해주세요.');
            const first500M = Array.from(internetPlanEl.options).find(opt => parseInt(opt.dataset.speed) === 500 && !opt.disabled);
            if (first500M) internetPlanEl.value = first500M.value;
            internetPlanEl.dispatchEvent(new Event('change'));
        }
    }
    discountTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const newlySelectedRadioValue = this.value;
            allDetailSections.forEach(section => {
                if (section.containerEl && section.toggleEl) {
                    let isVisible = false;
                    if (newlySelectedRadioValue === section.radioValue) {
                        isVisible = section.toggleEl.checked;
                        if (isVisible && section.updateFn) section.updateFn();
                    } else {
                        section.toggleEl.checked = false;
                        isVisible = false;
                    }
                    section.containerEl.classList.toggle('hidden', !isVisible);
                }
            });
            if (newlySelectedRadioValue === 'premiumSingleBundle') {
                mobileLinesCountEl.value = 1;
                mobileLinesCountEl.disabled = true;
            } else if (newlySelectedRadioValue === "none" || newlySelectedRadioValue === "familyBundle" || newlySelectedRadioValue === "mvnoBundle") {
                mobileLinesCountEl.value = 0;
                mobileLinesCountEl.disabled = true;
            } else {
                mobileLinesCountEl.disabled = false;
                if (parseInt(mobileLinesCountEl.value) === 0 && !mobileLinesCountEl.disabled) mobileLinesCountEl.value = 1;
            }
            updateMobileLinesInputs();
            updateMobilePlanOptions();
            updateInternetPlanOptions();
        });
    });
    allDetailSections.forEach(section => {
        if (section.toggleEl && section.containerEl && section.updateFn) {
            section.toggleEl.addEventListener('change', function() {
                const radioForThisToggle = document.querySelector(`input[name="discountType"][value="${section.radioValue}"]`);
                if (radioForThisToggle && radioForThisToggle.checked) {
                    section.containerEl.classList.toggle('hidden', !this.checked);
                    if (this.checked) section.updateFn();
                } else {
                    section.containerEl.classList.add('hidden');
                    this.checked = false;
                }
            });
        }
    });
    const internetTypeRadios = document.querySelectorAll('input[name="internetType"]');
    internetTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            populateInternetPlans();
            handleInternetTypeChange();
        });
    });
    function populateInternetPlans() {
        const selectedInternetType = document.querySelector('input[name="internetType"]:checked').value;
        const currentInternetPlan = internetPlanEl.value;
        internetPlanEl.innerHTML = '<option value="none">선택 안함</option>';
        for (const planKey in internetPlans_KT) {
            const plan = internetPlans_KT[planKey];
            let displayText = "";
            let matchesType = false;
            const speedText = plan.speed >= 1000 ? `${plan.speed / 1000}G` : `${plan.speed}M`;
            if (selectedInternetType === "bundle") {
                if (planKey.includes("번들")) {
                    displayText = `인터넷 ${speedText} (TV 결합 시) (월 ${plan.basePrice.toLocaleString()}원)`;
                    matchesType = true;
                }
            } else {
                if (planKey.includes("(단독)")) {
                    displayText = `인터넷(단독) ${speedText} (월 ${plan.basePrice.toLocaleString()}원)`;
                    matchesType = true;
                }
            }
            if (matchesType) {
                const option = document.createElement('option');
                option.value = planKey;
                option.textContent = displayText;
                option.dataset.price = plan.basePrice;
                option.dataset.speed = plan.speed;
                option.dataset.type = plan.type;
                internetPlanEl.appendChild(option);
            }
        }
        if (Array.from(internetPlanEl.options).some(opt => opt.value === currentInternetPlan)) internetPlanEl.value = currentInternetPlan;
        updateInternetPlanOptions();
        internetPlanEl.dispatchEvent(new Event('change'));
    }
    function handleInternetTypeChange() {
        const selectedInternetType = document.querySelector('input[name="internetType"]:checked').value;
        const isStandalone = selectedInternetType === 'standalone';
        tvPlanEl.disabled = isStandalone;
        additionalTvPlanEl.disabled = isStandalone;
        if (isStandalone) {
            tvPlanEl.value = "none";
            additionalTvPlanEl.value = "none";
            internetPlanEl.value = "KT인터넷(단독) 100mb";
        } else {
            internetPlanEl.value = "KT인터넷번들100mb";
            if (tvPlanEl.value === "none") tvPlanEl.value = "KTTV베이직";
        }
        tvPlanEl.dispatchEvent(new Event('change'));
        internetPlanEl.dispatchEvent(new Event('change'));
    }
    internetPlanEl.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        wifiRouterRentalEl.disabled = false;
        const currentWifi = wifiRouterRentalEl.options[wifiRouterRentalEl.selectedIndex];
        if (currentWifi && currentWifi.text.includes('프로모션')) wifiRouterRentalEl.value = "1100";
        if (!selectedOption || selectedOption.value === 'none') return;
        const internetSpeed = parseInt(selectedOption.dataset.speed);
        if (internetSpeed >= 1000) {
            const promoOption = Array.from(wifiRouterRentalEl.options).find(opt => opt.dataset.name === "KT WiFi 7D");
            if (promoOption) {
                promoOption.selected = true;
                wifiRouterRentalEl.disabled = true;
            }
        } else if (internetSpeed === 500) {
            const promoOption = Array.from(wifiRouterRentalEl.options).find(opt => opt.dataset.name === "GiGA WiFi home ax");
            if (promoOption) {
                promoOption.selected = true;
                wifiRouterRentalEl.disabled = true;
            }
        }
    });
    tvPlanEl.addEventListener('change', () => { const isTvSelected = tvPlanEl.value !== 'none'; });
    additionalTvPlanEl.addEventListener('change', () => { if (tvPlanEl.value === 'none' && additionalTvPlanEl.value !== 'none') { console.warn('첫 번째 TV를 먼저 선택해주세요.'); additionalTvPlanEl.value = 'none'; } });
    
    // ✨ [수정됨] 프리미엄 결합 시 요금제 기본값 설정 로직 변경
    function updateMobileLinesInputs() {
        const count = parseInt(mobileLinesCountEl.value) || 0;
        mobileLinesContainerEl.innerHTML = '';
        const selectedDiscountType = document.querySelector('input[name="discountType"]:checked').value;
        for (let i = 0; i < count; i++) {
            const div = document.createElement('div');
            div.className = 'mobile-line-item py-2 space-y-2';
            div.innerHTML = `<div><label for="mobilePlan${i}" class="block text-sm font-medium text-slate-600 mb-1">회선 ${i + 1} 요금제 선택</label><div class="flex items-center space-x-2"><label for="selectiveContract${i}" class="flex items-center text-sm font-medium text-slate-600 cursor-pointer hover:text-sky-600 p-2 rounded-md bg-slate-50 border border-slate-200"><input type="checkbox" id="selectiveContract${i}" class="selective-contract-checkbox radio-input h-4 w-4 mr-2">선택약정</label><select id="mobilePlan${i}" class="input-field mobile-plan-select flex-grow"><option value="0" data-name="미선택" data-url="">요금제 선택</option>${mobilePlans_KT.map(plan => `<option value="${plan.price}" data-name="${plan.name}" data-url="${plan.url}">${plan.name} (${plan.price.toLocaleString()}원)</option>`).join('')}</select></div></div>`;
            mobileLinesContainerEl.appendChild(div);
            
            const newSelect = document.getElementById(`mobilePlan${i}`);
            // 할인 유형별 기본 요금제 설정
            if (selectedDiscountType === 'premiumFamilyBundle') {
                if (i < 2) {
                    newSelect.value = "80000"; // 1~2회선: 베이직(80,000원)
                } else {
                    newSelect.value = "69000"; // 3회선부터: 5G 심플 110GB(69,000원)
                }
            } else if (selectedDiscountType === 'premiumSingleBundle') {
                 newSelect.value = "80000"; // 베이직(80,000원)
            } else if (selectedDiscountType === 'totalAmountBundle' || selectedDiscountType === 'separateFamilyBundle') {
                 if (i === 0) newSelect.value = "37000"; // 첫 회선만 기본값 설정
            }
        }
        document.querySelectorAll('.mobile-plan-select, .selective-contract-checkbox').forEach(el => {
            el.addEventListener('change', () => {
                const currentDiscountType = document.querySelector('input[name="discountType"]:checked').value;
                const section = allDetailSections.find(s => s.radioValue === currentDiscountType);
                if (section && section.toggleEl.checked && section.updateFn) section.updateFn();
            });
        });
        updateMobilePlanOptions();
    }
    function getSelectedInternetInfo(planName) {
        if (!planName || planName === 'none' || !internetPlans_KT[planName]) return { basePrice: 0, modemFee: 0, type: "none", speed: 0 };
        let basePrice = internetPlans_KT[planName].basePrice;
        const selectedOption = internetPlanEl.options[internetPlanEl.selectedIndex];
        if (selectedOption && selectedOption.value !== 'none' && selectedOption.text.includes("KT인터넷번들")) basePrice = internetPlans_KT[planName].basePrice;
        return { ...internetPlans_KT[planName], basePrice: basePrice };
    }
    function getMobileTierKey(totalMobileBaseCost, numMobileLines, internetSpeedType) {
        if (numMobileLines === 0 || totalMobileBaseCost === 0) return null;
        if (internetSpeedType === "100M") {
            if (totalMobileBaseCost < 22000) return "모바일_22000미만";
            if (totalMobileBaseCost < 64900) return "모바일_64900미만";
            return "모바일_64900이상";
        } else {
            if (totalMobileBaseCost < 22000) return "모바일_22000미만";
            return "모바일_22000이상";
        }
    }
    function getMobileTierKeyFor500MUp(totalMobileBaseCost, numMobileLines){ if (numMobileLines === 0 || totalMobileBaseCost === 0) return null; if (totalMobileBaseCost < 22000) return "모바일_22000미만"; return "모바일_22000이상"; }
    function getMobileTierKeyForSeparateFamily(totalMobileBaseCost, numMobileLines){ if (numMobileLines === 0 || totalMobileBaseCost === 0) return null; if (totalMobileBaseCost < 22000) return "모바일_22000미만"; return "모바일_22000이상"; }
    
    function updateMvnoDetails() {
        mvnoDetailsContainerEl.innerHTML = `
            <h4 class="font-semibold text-sm mb-2 text-slate-700">알뜰폰 결합 상세 정보</h4>
            <ul class="list-disc list-inside text-xs space-y-2">
                <li>
                    <strong>인터넷 할인액 (모바일 할인 없음):</strong>
                    <ul class="list-circle list-inside ml-4 mt-1">
                        <li>100M 인터넷: 3,300원 할인</li>
                        <li>500M/1G 인터넷 (단독): 11,000원 할인</li>
                        <li>500M/1G 인터넷 (TV 결합): 5,500원 할인</li>
                    </ul>
                </li>
                <li><strong>결합 가능 알뜰폰 통신사:</strong>
                    <p class="text-slate-500 mt-1 pl-2">
                        엠모바일, 미니게이트(쉐이크모바일), 유니컴즈(모빙), 토스모바일, 국민은행(리브모바일), 더피엔엘(퍼스트모바일), 에르엘(오파스넷모바일), 고고팩토리, 스마텔, 스카이라이프(일부 요금제 제외), 코드모바일, 프리티, 니오라코리아, 스피츠모바일, 아이즈비전
                    </p>
                </li>
                <li><strong class="text-red-600">유의사항:</strong>
                    <ul class="list-circle list-inside ml-4 mt-1">
                        <li>개인/법인 사업자 명의는 결합이 불가합니다.</li>
                        <li>인터넷 설치 완료 후, 고객님께서 직접 알뜰폰 통신사 고객센터로 결합을 요청하셔야 합니다.</li>
                        <li>결합 후 알뜰폰 통신사를 변경하실 경우, 기존 결합은 해지되며 재결합이 불가할 수 있습니다.</li>
                    </ul>
                </li>
            </ul>
        `;
    }

    function updateTotalAmountDetails() { totalAmountDetailsContainerEl.innerHTML = `<h4 class="font-semibold text-sm mb-2 text-slate-700">총액 결합할인 상세 정보</h4><p class="text-xs text-slate-600 mb-2">모바일 총액에 따라 인터넷 요금을 할인받는 방식입니다. 5G/LTE 구분 없이 결합 가능합니다.</p><ul class="list-disc list-inside text-xs space-y-1"><li><strong>100M 인터넷:</strong><ul class="list-circle list-inside ml-4"><li>모바일 총액 22,000원 미만: 1,650원 할인</li><li>모바일 총액 64,900원 미만: 3,300원 할인</li><li>모바일 총액 64,900원 이상: 5,500원 할인 + 모바일 추가할인</li></ul></li><li><strong>500M/1G 인터넷 (TV/전화 결합 시):</strong><ul class="list-circle list-inside ml-4"><li>모바일 총액 22,000원 미만: 2,200원 할인</li><li>모바일 총액 22,000원 이상: 5,500원 할인 + 모바일 추가할인</li></ul></li><li><strong>500M/1G 인터넷 (단독):</strong><ul class="list-circle list-inside ml-4"><li>모바일 총액 22,000원 미만: 7,700원 할인</li><li>모바일 총액 22,000원 이상: 11,000원 할인 + 모바일 추가할인</li></ul></li></ul>`; }
    function updatePremiumFamilyDetails() { premiumFamilyDetailsContainerEl.innerHTML = `<h4 class="font-semibold text-sm mb-2 text-slate-700">프리미엄 가족결합 상세 정보</h4><p class="text-xs text-slate-600 mb-2">5G/LTE 8만원 이상 요금제를 사용하는 가족 구성원이 있을 때 유리한 결합입니다.</p><ul class="list-disc list-inside text-xs space-y-1"><li><strong>조건:</strong> 500M 이상 인터넷 + 1번째 회선부터 5G/LTE 8만원 이상 요금제 사용</li><li><strong>인터넷 할인:</strong> 5,500원 ~ 11,000원 할인</li><li><strong>모바일 할인:</strong><ul class="list-circle list-inside ml-4"><li>1번째 회선: 5,500원 할인 + (조건 충족 시 총액결합 추가 할인)</li><li>2번째 회선 이상 (8만원+ 요금제): 월정액의 25% 할인</li><li>3번째 회선 이상 (8만원 미만 요금제): 조건 충족 시 총액결합 할인 적용</li></ul></li><li><strong>참고:</strong> 100M 인터넷은 결합 불가. 3회선 이상이 77,000원 이하 요금제일 경우, 1회선 요금과 합산하여 총액결합할인이 계산되어 1회선과 3회선 이상에 분배됩니다.</li></ul>`; }
    function updatePremiumSingleDetails() { premiumSingleDetailsContainerEl.innerHTML = `<h4 class="font-semibold text-sm mb-2 text-slate-700">프리미엄 싱글결합 상세 정보</h4><p class="text-xs text-slate-600 mb-2">5G/LTE 8만원 이상 요금제를 혼자 사용하고 인터넷 단독으로 사용할 때 유리합니다.</p><ul class="list-disc list-inside text-xs space-y-1"><li><strong>조건:</strong> 500M 이상 인터넷 단독 + 5G/LTE 8만원 이상 요금제 1회선</li><li><strong>인터넷 할인:</strong> 5,500원 할인</li><li><strong>모바일 할인:</strong> 월정액의 25% 할인</li><li><strong>참고:</strong> 100M 인터넷 및 TV/전화 결합 시에는 가입 불가</li></ul>`; }
    function updateFamilyBundleDetails() { familyBundleDetailsContainerEl.innerHTML = `<h4 class="font-semibold text-sm mb-2 text-slate-700">패밀리 결합 상세 정보</h4><p class="text-xs text-slate-600 mb-2">기존 KT 인터넷을 사용하는 가족이 추가로 인터넷을 설치할 때 적용됩니다. (모바일 결합 불필요)</p><ul class="list-disc list-inside text-xs space-y-1"><li><strong>100M 인터넷:</strong> 5,500원 할인</li><li><strong>500M/1G 인터넷 (단독):</strong> 11,000원 할인</li><li><strong>500M/1G 인터넷 (TV 결합):</strong> 5,500원 할인</li></ul>`; }
    function updateSeparateFamilyDetails() { separateFamilyDetailsContainerEl.innerHTML = `<h4 class="font-semibold text-sm mb-2 text-slate-700">따로 살아도 가족결합 상세 정보</h4><p class="text-xs text-slate-600 mb-2">가족관계증명서로 증빙 가능한 가족이 따로 살면서 인터넷+TV와 모바일을 결합할 때 적용됩니다.</p><ul class="list-disc list-inside text-xs space-y-1"><li><strong>조건:</strong> 500M 이상 인터넷 + TV + 모바일 1회선 이상</li><li><strong>인터넷+TV 할인:</strong><ul class="list-circle list-inside ml-4"><li><strong>500M:</strong> 9,900원(인터넷) + 2,200원(TV) = 총 12,100원 할인</li><li><strong>1G:</strong> 11,000원(인터넷) + 3,300원(TV) = 총 14,300원 할인</li></ul></li><li><strong>모바일 할인:</strong> 없음</li><li><strong>참고:</strong> 100M 인터넷 또는 인터넷 단독은 결합 불가</li></ul>`; }
    function calculateInstallationFee(internetSelected, tvSelected, phonePlanName, additionalTvSelected, installTime) {
        const timeKey = installTime === 'weekday' ? '평일' : '주말';
        const feeTable = ktInstallationFees_new[timeKey];
        if (!feeTable) return { fee: 0, desc: "설치 시간대를 선택해주세요." };
        let fee = 0;
        let desc = "산정 불가";
        let combinationKey = "";
        const phoneSelected = phonePlanName !== 'none';
        const isGeneralPhone = phoneSelected && phonePlanName.includes("일반 전화");
        const is070Phone = phoneSelected && phonePlanName.includes("인터넷 전화");
        if (internetSelected && tvSelected && additionalTvSelected) { combinationKey = "인터넷+TV+TV추가"; desc = "인터넷 + TV + 추가 TV"; }
        else if (internetSelected && tvSelected && isGeneralPhone) { combinationKey = "인터넷+TV+일반전화"; desc = "인터넷 + TV + 일반전화"; }
        else if (internetSelected && tvSelected && is070Phone) { combinationKey = "인터넷+TV+070전화"; desc = "인터넷 + TV + 070전화"; }
        else if (internetSelected && tvSelected) { combinationKey = "인터넷+TV"; desc = "인터넷 + TV"; }
        else if (internetSelected && isGeneralPhone) { combinationKey = "인터넷+일반전화"; desc = "인터넷 + 일반전화"; }
        else if (internetSelected && is070Phone) { combinationKey = "인터넷+070전화"; desc = "인터넷 + 070전화"; }
        else if (internetSelected) { combinationKey = "인터넷"; desc = "인터넷 단독"; }
        else { if (tvSelected) { fee = 0; desc = "TV 단독 (비용 별도 문의)"; } else if (phoneSelected) { fee = 0; desc = "전화 단독 (비용 별도 문의)"; } return { fee, desc }; }
        fee = feeTable[combinationKey] || 0;
        if (timeKey === '주말' && fee > 0 && feeTable["유효기간"]) desc += ` (${feeTable["유효기간"]})`;
        return { fee, desc };
    }
    
    function calculateAndDisplayResults() {
        try {
            const internetPlanName = internetPlanEl.value;
            const selectedWifiOptionEl = wifiRouterRentalEl.options[wifiRouterRentalEl.selectedIndex];
            const selectedWifiName = selectedWifiOptionEl ? selectedWifiOptionEl.dataset.name : "KT공유기 X";
            const tvPlanName = tvPlanEl.value;
            const additionalTvPlanKey = additionalTvPlanEl.value;
            const phonePlanName = phonePlanEl.value;
            const discountType = document.querySelector('input[name="discountType"]:checked').value;
            const displayMode = document.querySelector('input[name="displayModeKt"]:checked').value;
            const installationTime = document.querySelector('input[name="installationTime"]:checked').value;
            const selectedAddonCheckboxes = document.querySelectorAll('#addonServicesContainer input[type="checkbox"]:checked');
            const isDongpanChecked = dongpanSalesCheckKtEl ? dongpanSalesCheckKtEl.checked : false;
            let totalMobileBaseCost = 0;
            let mobileLinesData = [];
            document.querySelectorAll('.mobile-line-item').forEach((item, i) => {
                const select = item.querySelector(`#mobilePlan${i}`);
                const checkbox = item.querySelector(`#selectiveContract${i}`);
                const option = select.options[select.selectedIndex];
                mobileLinesData.push({ cost: parseInt(option.value) || 0, name: option.dataset.name, url: option.dataset.url, applySelectiveContract: checkbox.checked });
                totalMobileBaseCost += parseInt(option.value) || 0;
            });
            const numMobileLines = mobileLinesData.length;
            let tvBase = (tvPlanName !== 'none' && tvPlans_KT[tvPlanName]) ? tvPlans_KT[tvPlanName].basePrice : 0;
            let additionalTvCost = (additionalTvPlanKey !== 'none' && additionalTvPlans_KT[additionalTvPlanKey]) ? additionalTvPlans_KT[additionalTvPlanKey].basePrice : 0;
            let phoneBase = (phonePlanName !== 'none' && phonePlans_KT[phonePlanName]) ? phonePlans_KT[phonePlanName].basePrice : 0;
            let currentInternet = getSelectedInternetInfo(internetPlanName);
            let internetBase = internetPlanName !== 'none' ? (parseFloat(currentInternet.basePrice) || 0) : 0;
            const selectedWifiData = wifiOptions_KT[selectedWifiName];
            let actualWifiRouterFee = selectedWifiData ? selectedWifiData.fee : 0;
            let addonServicesTotalCost = 0;
            selectedAddonCheckboxes.forEach(checkbox => { addonServicesTotalCost += (parseFloat(checkbox.dataset.price) || 0); });
            let internetDiscount = 0;
            let currentTvDiscount = 0;
            let totalMobileDiscount = 0;
            let mobileDiscountDescription = '결합에 따른 모바일 할인 없음.';
            const isTvOrPhoneBundled = tvPlanName !== 'none' || phonePlanEl.value !== 'none';
            if (discountType !== 'none' && internetPlanName !== 'none') {
                const internetSpeedType = currentInternet.type;
                const bundleTypeForDiscountRule = isTvOrPhoneBundled ? "TV" : "단독";
                if (discountType === 'totalAmountBundle') {
                    let mobileTierKey = getMobileTierKey(totalMobileBaseCost, numMobileLines, internetSpeedType);
                    if (mobileTierKey && newKtDiscountRules.총액결합할인?.[internetSpeedType]?.[bundleTypeForDiscountRule]?.[mobileTierKey]) { internetDiscount = newKtDiscountRules.총액결합할인[internetSpeedType][bundleTypeForDiscountRule][mobileTierKey]; }
                    else if (internetSpeedType === "1G" && bundleTypeForDiscountRule === "TV" && newKtDiscountRules.총액결합할인?.["1G"]?.TV?.["모바일_결합시"] && numMobileLines > 0) { internetDiscount = newKtDiscountRules.총액결합할인["1G"]["TV"]["모바일_결합시"]; }
                } else if (discountType === 'premiumFamilyBundle') {
                    const firstLineCost = numMobileLines > 0 ? mobileLinesData[0].cost : 0;
                    if (numMobileLines > 0 && firstLineCost >= 80000 && currentInternet.speed >= 500) {
                        const fullKey = (currentInternet.speed >= 1000 ? "1G" : "500M") + (isTvOrPhoneBundled ? "_TV" : "_단독");
                        internetDiscount = newKtDiscountRules.프리미엄가족결합?.[fullKey] || 0;
                    }
                } else if (discountType === 'premiumSingleBundle') {
                    const singleLineCost = numMobileLines === 1 ? mobileLinesData[0].cost : 0;
                    if (singleLineCost >= 80000 && currentInternet.speed >= 500 && !isTvOrPhoneBundled) {
                        const speedKey = (currentInternet.speed === 500 ? "500M" : "1G") + "_단독";
                        internetDiscount = newKtDiscountRules.프리미엄싱글결합?.[speedKey] || 0;
                    }
                } else if (discountType === 'mvnoBundle' || discountType === 'familyBundle') {
                    const fullKey = internetSpeedType + "_" + bundleTypeForDiscountRule;
                    const rule = discountType === 'mvnoBundle' ? newKtDiscountRules.알뜰폰결합 : newKtDiscountRules.패밀리결합;
                    internetDiscount = rule?.[fullKey] || 0;
                } else if (discountType === 'separateFamilyBundle' && isTvOrPhoneBundled) {
                    let speedKeyFor따살 = (currentInternet.speed === 500) ? "500M_TV" : (currentInternet.speed >= 1000) ? "1G_TV" : "";
                    let mobileTierKeyFor따살 = getMobileTierKeyForSeparateFamily(totalMobileBaseCost, numMobileLines);
                    if (speedKeyFor따살 && mobileTierKeyFor따살 && newKtDiscountRules["따로살아도 가족결합"]?.[speedKeyFor따살]?.[mobileTierKeyFor따살]) {
                        internetDiscount = newKtDiscountRules["따로살아도 가족결합"][speedKeyFor따살][mobileTierKeyFor따살];
                        currentTvDiscount = newKtDiscountRules["따로살아도 가족결합"][speedKeyFor따살].tvDiscount || 0;
                    }
                }
                internetDiscount = Math.min(internetDiscount, internetBase);
                mobileDiscountDescription = '<div class="space-y-3">';
                let mobileLineItemsHtml = '';
                totalMobileDiscount = 0;
                
                let premiumFamilyProportionalDiscounts = new Map();
                let totalAmountProportionalDiscounts = new Map();

                // ✨ [수정됨] 총액결합할인 기여도 기반 분배 로직
                if (discountType === 'totalAmountBundle' && numMobileLines > 0 && totalMobileBaseCost > 0) {
                    const internetSpeedKeyForJson = (currentInternet.speed >= 500) ? "500M_1G" : "100M";
                    let mobileTierKeyForJson = null;
                    if (totalMobileBaseCost < 22000) mobileTierKeyForJson = "tier1_under_22000";
                    else if (totalMobileBaseCost < 64900) mobileTierKeyForJson = "tier2_22000_to_64899";
                    else if (totalMobileBaseCost < 108900) mobileTierKeyForJson = "tier3_64900_to_108899";
                    else if (totalMobileBaseCost < 141900) mobileTierKeyForJson = "tier4_108900_to_141899";
                    else if (totalMobileBaseCost < 174900) mobileTierKeyForJson = "tier5_141900_to_174899";
                    else mobileTierKeyForJson = "tier6_over_174900";
                    const discountInfo = kt_total_mobile_fee_discounts[internetSpeedKeyForJson]?.[mobileTierKeyForJson];
                    const totalMobileDiscountForGroup = discountInfo?.mobile_discount || 0;

                    if (totalMobileDiscountForGroup > 0) {
                        let distributedSum = 0;
                        mobileLinesData.forEach((line, index) => {
                            if (index < numMobileLines - 1) {
                                const discount = Math.round(totalMobileDiscountForGroup * (line.cost / totalMobileBaseCost));
                                totalAmountProportionalDiscounts.set(index, discount);
                                distributedSum += discount;
                            }
                        });
                        if (numMobileLines > 0) {
                           totalAmountProportionalDiscounts.set(numMobileLines - 1, totalMobileDiscountForGroup - distributedSum);
                        }
                    }
                }

                if (discountType === 'premiumFamilyBundle' && numMobileLines > 0) {
                    const linesUnder77k = mobileLinesData.map((line, index) => ({ ...line, originalIndex: index })).filter((line, index) => index > 0 && line.cost > 0 && line.cost < 77000);
                    if (linesUnder77k.length > 0 && mobileLinesData[0].cost > 0) {
                        const participatingLines = [{ ...mobileLinesData[0], originalIndex: 0 }, ...linesUnder77k];
                        const totalCostForSpecialCalc = participatingLines.reduce((sum, line) => sum + line.cost, 0);
                        const internetSpeedKeyForJson = (currentInternet.speed >= 500) ? "500M_1G" : "100M";
                        let mobileTierKeyForJson = null;
                        if (totalCostForSpecialCalc < 22000) { mobileTierKeyForJson = "tier1_under_22000"; } 
                        else if (totalCostForSpecialCalc < 64900) { mobileTierKeyForJson = "tier2_22000_to_64899"; } 
                        else if (totalCostForSpecialCalc < 108900) { mobileTierKeyForJson = "tier3_64900_to_108899"; } 
                        else if (totalCostForSpecialCalc < 141900) { mobileTierKeyForJson = "tier4_108900_to_141899"; } 
                        else if (totalCostForSpecialCalc < 174900) { mobileTierKeyForJson = "tier5_141900_to_174899"; } 
                        else { mobileTierKeyForJson = "tier6_over_174900"; }
                        const discountInfo = kt_total_mobile_fee_discounts[internetSpeedKeyForJson]?.[mobileTierKeyForJson];
                        const totalMobileDiscountForGroup = discountInfo?.mobile_discount || 0;
                        if (totalMobileDiscountForGroup > 0) {
                            let distributedSum = 0;
                            participatingLines.filter(p => p.originalIndex !== 0).forEach(pLine => { const discount = Math.round(totalMobileDiscountForGroup * (pLine.cost / totalCostForSpecialCalc)); premiumFamilyProportionalDiscounts.set(pLine.originalIndex, discount); distributedSum += discount; });
                            premiumFamilyProportionalDiscounts.set(0, totalMobileDiscountForGroup - distributedSum);
                        }
                    }
                }
                
                mobileLinesData.forEach((line, i) => {
                    if (line.cost === 0) return;
                    let selectiveDiscount = line.applySelectiveContract ? Math.floor(line.cost * 0.25) : 0;
                    let bundleDiscount = 0;
                    let totalAmountLineDiscount = totalAmountProportionalDiscounts.get(i) || 0;
                    
                    // ✨ [수정됨] 프리미엄 결합 할인 계산 시 8만원 기준으로 변경
                    if (discountType === 'premiumFamilyBundle') { 
                        if (premiumFamilyProportionalDiscounts.has(i)) { 
                            bundleDiscount = premiumFamilyProportionalDiscounts.get(i); 
                        } else { 
                            if (i === 0 && line.cost >= 80000) { 
                                bundleDiscount = 5500; 
                            } else if (i >= 1 && line.cost >= 80000) { 
                                bundleDiscount = Math.floor(line.cost * 0.25); 
                            } 
                        } 
                    } else if (discountType === 'premiumSingleBundle') { 
                        if (i === 0 && line.cost >= 80000) {
                            bundleDiscount = Math.floor(line.cost * 0.25); 
                        }
                    }

                    const totalLineDiscount = selectiveDiscount + bundleDiscount + totalAmountLineDiscount;
                    const finalBill = line.cost - totalLineDiscount;
                    totalMobileDiscount += totalLineDiscount;
                    let discountDetailString = '';
                    if (totalAmountLineDiscount > 0) discountDetailString += ` - ${totalAmountLineDiscount.toLocaleString()}원(총액할인)`;
                    if (bundleDiscount > 0) discountDetailString += ` - ${bundleDiscount.toLocaleString()}원(결합)`;
                    if (selectiveDiscount > 0) discountDetailString += ` - ${selectiveDiscount.toLocaleString()}원(선택약정)`;
                    mobileLineItemsHtml += `<div class="p-2 border-t border-slate-200"><p class="font-semibold">${line.name} (${line.cost.toLocaleString()}원)</p><p class="text-sm pl-2"> ㄴ ${line.cost.toLocaleString()}원${discountDetailString} = <strong class="text-blue-600">${finalBill.toLocaleString()}원</strong> <a href="${line.url}" target="_blank" class="text-blue-500 hover:underline">(상세)</a></p></div>`;
                });

                if (mobileLineItemsHtml) mobileDiscountDescription += mobileLineItemsHtml;
                else if (numMobileLines > 0) mobileDiscountDescription += `<p>결합에 따른 모바일 할인 없음.</p>`;
                mobileDiscountDescription += '</div>';
            }
            const finalInternetComponentCost_NoDiscount = internetBase + actualWifiRouterFee + tvBase + additionalTvCost + phoneBase + addonServicesTotalCost;
            const finalInternetComponentCost_WithDiscount = (internetBase - internetDiscount) + actualWifiRouterFee + (tvBase - currentTvDiscount) + additionalTvCost + phoneBase + addonServicesTotalCost;
            let finalMonthlyDisplayCost = (displayMode === 'preApplied') ? finalInternetComponentCost_WithDiscount : finalInternetComponentCost_NoDiscount;
            summaryFinalCostEl.textContent = `${finalMonthlyDisplayCost.toLocaleString()} 원`;
            if (summaryPreDiscountCostEl) {
                if (finalInternetComponentCost_NoDiscount > finalMonthlyDisplayCost) {
                    summaryPreDiscountCostEl.textContent = `할인 전 ${finalInternetComponentCost_NoDiscount.toLocaleString()} 원`;
                    summaryPreDiscountCostEl.style.display = 'block';
                } else {
                    summaryPreDiscountCostEl.style.display = 'none';
                }
            }
            summaryInternetDiscountEl.textContent = `- ${(internetDiscount + currentTvDiscount).toLocaleString()} 원`;
            summaryMobileDiscountEl.textContent = `- ${totalMobileDiscount.toLocaleString()} 원`;
            let internetPlanText = internetPlanName !== 'none' ? internetPlanEl.options[internetPlanEl.selectedIndex].text.split(" (")[0] : '미선택';
            selectedInternetEl.textContent = internetPlanText;
            selectedTvEl.textContent = tvPlanName !== 'none' ? tvPlanEl.options[tvPlanEl.selectedIndex].text.split(" (")[0] : '미선택';
            selectedAdditionalTvEl.textContent = additionalTvPlanKey !== 'none' ? additionalTvPlans_KT[additionalTvPlanKey].name : '미선택';
            selectedPhoneEl.textContent = phonePlanName !== 'none' ? phonePlanEl.options[phonePlanEl.selectedIndex].text.split(" (")[0] : '미선택';
            selectedWifiEl.textContent = selectedWifiName || '미선택';
            selectedMobileCountEl.textContent = numMobileLines;
            if (selectedWifiData && selectedWifiData.promotion) {
                selectedWifiDetailsEl.innerHTML = `<p class="text-sm text-sky-700 mt-1"> ㄴ 프로모션: ${selectedWifiData.promotion} ${selectedWifiData.url ? `<a href="${selectedWifiData.url}" target="_blank" class="font-semibold underline hover:text-sky-500 ml-2">[제품 상세정보]</a>` : ''}</p>`;
            } else {
                selectedWifiDetailsEl.innerHTML = '';
            }
            const discountTypeMap = { none: "결합 할인 없음", totalAmountBundle: "총액 결합할인", premiumFamilyBundle: "프리미엄 가족결합", premiumSingleBundle: "프리미엄 싱글결합", mvnoBundle: "알뜰폰 결합", familyBundle: "패밀리 결합 (인터넷 추가회선)", separateFamilyBundle: "따로 살아도 가족결합" };
            selectedDiscountTypeEl.textContent = discountTypeMap[discountType] || "알 수 없음";
            detailInternetBaseEl.textContent = `${(internetBase + tvBase + additionalTvCost + phoneBase + addonServicesTotalCost).toLocaleString()} 원`;
            detailWifiFeeEl.textContent = `${actualWifiRouterFee.toLocaleString()} 원`;
            detailInternetDiscountTotalEl.textContent = `- ${(internetDiscount + currentTvDiscount).toLocaleString()} 원`;
            detailFinalCostEl.textContent = `${finalMonthlyDisplayCost.toLocaleString()} 원`;
            mobileDiscountDetailContainerEl.innerHTML = mobileDiscountDescription;
            let giftCash = 0, giftVoucher = 0, giftPhoneVoucherAmount = 0, giftAdditionalTvAmount = 0, giftDongpanAdditionalCashAmount = 0;
            if (internetPlanName !== 'none') {
                const internetSpeed = currentInternet.speed;
                const isTvSelectedForGift = tvPlanName !== 'none';
                const tvCategoryForGift = isTvSelectedForGift ? (tvPlanEl.options[tvPlanEl.selectedIndex].dataset.category || "베이직") : "베이직";
                let giftKeyPrefix = "";
                if (!isTvSelectedForGift) { if (internetSpeed === 100) giftKeyPrefix = "100단독"; else if (internetSpeed === 500) giftKeyPrefix = "500단독"; else if (internetSpeed >= 1000) giftKeyPrefix = "1G단독"; }
                else { if (internetSpeed === 100) giftKeyPrefix = "100번들"; else if (internetSpeed === 500) giftKeyPrefix = "500번들"; else if (internetSpeed >= 1000) giftKeyPrefix = "기가번들"; }
                if (giftTable[tvCategoryForGift] && giftTable[tvCategoryForGift][giftKeyPrefix]) { giftCash = giftTable[tvCategoryForGift][giftKeyPrefix].cash; giftVoucher = giftTable[tvCategoryForGift][giftKeyPrefix].voucher; }
                if (isDongpanChecked && numMobileLines > 0) {
                    const dongpanBundleType = isTvSelectedForGift ? "TV번들" : "단독";
                    let internetGiftKeyPart = (internetSpeed === 100) ? "100M" : (internetSpeed === 500) ? "500M" : "1G";
                    const maxDongpanLines = isTvSelectedForGift ? 3 : 1;
                    for (let i = 0; i < Math.min(numMobileLines, maxDongpanLines); i++) {
                        const mobileLineFee = mobileLinesData[i].cost;
                        let mobileFeeTierKey = null;
                        if (mobileLineFee >= 37000 && mobileLineFee < 61000) mobileFeeTierKey = "37K";
                        else if (mobileLineFee >= 61000 && mobileLineFee < 90000) mobileFeeTierKey = "61K";
                        else if (mobileLineFee >= 90000) mobileFeeTierKey = "90K";
                        if (mobileFeeTierKey && internetGiftKeyPart) { const giftKey = internetGiftKeyPart + "_" + dongpanBundleType; if (dongpanAdditionalGiftTable_KT[mobileFeeTierKey] && dongpanAdditionalGiftTable_KT[mobileFeeTierKey][giftKey]) giftDongpanAdditionalCashAmount += dongpanAdditionalGiftTable_KT[mobileFeeTierKey][giftKey]; }
                    }
                }
            }
            if (phonePlanName !== 'none') giftPhoneVoucherAmount = 20000;
            if (additionalTvPlanKey !== 'none') giftAdditionalTvAmount = 30000;
            const totalGift = giftCash + giftVoucher + giftPhoneVoucherAmount + giftAdditionalTvAmount + giftDongpanAdditionalCashAmount;
            summaryGiftTotalEl.textContent = `${totalGift.toLocaleString()} 원`;
            giftCashEl.textContent = `${giftCash.toLocaleString()} 원`;
            giftVoucherEl.textContent = `${giftVoucher.toLocaleString()} 원`;
            giftPhoneVoucherEl.textContent = `${giftPhoneVoucherAmount.toLocaleString()} 원`;
            giftAdditionalTvEl.textContent = `${giftAdditionalTvAmount.toLocaleString()} 원`;
            dongpanCashContainerKtEl.classList.toggle('hidden', !isDongpanChecked || giftDongpanAdditionalCashAmount === 0);
            giftDongpanAdditionalCashKtEl.textContent = `${giftDongpanAdditionalCashAmount.toLocaleString()} 원`;
            giftTotalEl.textContent = `${totalGift.toLocaleString()} 원`;
            const installInfo = calculateInstallationFee(internetPlanName !== 'none', tvPlanName !== 'none', phonePlanName, additionalTvPlanKey !== 'none', installationTime);
            installationFeeResultEl.textContent = `${installInfo.fee.toLocaleString()} 원`;
            installationFeeDescriptionEl.textContent = `(${installInfo.desc}, ${installationTime === 'weekday' ? '평일 주간' : '주말/야간'} 기준)`;
            const tvOptionForMessage = tvPlanEl.options[tvPlanEl.selectedIndex];
            const firstTvTextForMessage = tvOptionForMessage.value !== 'none' ? tvOptionForMessage.text.split(' (')[0] : '미선택';
            const additionalTvTextForMessage = additionalTvPlanKey !== 'none' ? ` + (추가)${additionalTvPlans_KT[additionalTvPlanKey].name}` : "";
            const giftAmountText = summaryGiftTotalEl.textContent.trim();
            const consultMessage = `[KT 결합 계산기 문의]\n- 인터넷: ${internetPlanText}\n- TV: ${firstTvTextForMessage}${additionalTvTextForMessage}\n- 할인유형: ${selectedDiscountTypeEl.textContent}\n- 최종 월 요금: ${finalMonthlyDisplayCost.toLocaleString()}원\n- 총 사은품: ${giftAmountText}\n\n위 내용으로 상담 부탁드립니다.`;
            const encodedMessage = encodeURIComponent(consultMessage);
            kakaoBtn.href = `https://pf.kakao.com/${kakaoChannelId}/chat?text=${encodedMessage}`;
            smsBtn.href = `sms:${myPhoneNumber}?body=${encodedMessage}`;
            resultSection.classList.remove('hidden');
            customerConsultSection.classList.remove('hidden');
            installationFeeSectionEl.classList.remove('hidden');
        } catch (error) {
            console.error("계산 중 오류 발생:", error);
            // alert("계산 중 오류가 발생했습니다. 입력 값을 확인하거나 잠시 후 다시 시도해주세요.");
        }
    }
    function resetCalculator() {
        setInitialDefaults();
        resultSection.classList.add('hidden');
        customerConsultSection.classList.add('hidden');
        installationFeeSectionEl.classList.add('hidden');
        expandedDetailsContainer.classList.add('hidden');
        toggleDetailsButton.innerHTML = '상세 요금 내역 펼쳐보기 ▼';
        if(selectedWifiDetailsEl) selectedWifiDetailsEl.innerHTML = '';
        window.scrollTo(0, 0);
    }
    function setInitialDefaults() {
        document.querySelector('input[name="internetType"][value="standalone"]').checked = true;
        populateInternetPlans();
        internetPlanEl.value = "KT인터넷(단독) 100mb";
        tvPlanEl.value = "none";
        additionalTvPlanEl.value = "none";
        phonePlanEl.value = "none";
        wifiRouterRentalEl.value = "1100";
        wifiRouterRentalEl.disabled = false;
        const addonCheckboxes = document.querySelectorAll('#addonServicesContainer input[type="checkbox"]');
        addonCheckboxes.forEach(cb => cb.checked = false);
        document.querySelector('input[name="discountType"][value="totalAmountBundle"]').checked = true;
        document.querySelector('input[name="displayModeKt"][value="preApplied"]').checked = true;
        document.querySelector('input[name="installationTime"][value="weekday"]').checked = true;
        if (dongpanSalesCheckKtEl) {
            dongpanSalesCheckKtEl.checked = false;
            if(dongpanPolicyDetailsContainerKtEl) dongpanPolicyDetailsContainerKtEl.classList.add('hidden');
        }
        allDetailSections.forEach(section => {
            if (section.containerEl && section.toggleEl) {
                const isSelected = document.querySelector(`input[name="discountType"][value="${section.radioValue}"]`).checked;
                let shouldBeVisible = false;
                if (isSelected) {
                    section.toggleEl.checked = false;
                    shouldBeVisible = section.toggleEl.checked;
                } else {
                    section.toggleEl.checked = false;
                }
                section.containerEl.classList.toggle('hidden', !shouldBeVisible);
            }
        });
        document.querySelector('input[name="internetType"]:checked').dispatchEvent(new Event('change'));
        document.querySelector('input[name="discountType"]:checked').dispatchEvent(new Event('change'));
        document.querySelectorAll('.selective-contract-checkbox').forEach(cb => cb.checked = false);
    }
    window.onload = setInitialDefaults;
    </script>
</body>
</html>
